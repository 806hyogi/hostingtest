<!DOCTYPE html>
<html style="height:100%;">

<head>
  <meta charset="UTF-8">
  <title>KaKaoMap Study</title>
  <style>
    /* GPS 버튼 스타일 */
    .gps-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 10px;
      background-color: white;
      border-radius: 4px;
      border: solid 1px #ccc;
    }

    /* GPS 아이콘 스타일 */
    .gps-icon {
        display:inline-block; 
        width :15px; 
        height :15px; 
        background:url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/location.png') no-repeat; 
        background-size :15px
    }
  </style>
</head>

<body style="margin:0; padding:0; height:100%;">
  <div id="map" style="width:100%;height:90%;"></div>

  <!--GPS버튼 -->
  <button class='gps-btn' onclick='moveToCurrentLocation()'>
  <span class='gps-icon'></span> 현재 위치
  </button>
  
  <!-- 카카오 맵 API 연동 -->
  <script type="text/javascript"
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=baa1f48d1a2ac62f865637b2ddb9ac08&libraries=services"></script>
  <script type="text/javascript">

    var marker;
    var currentPosition;
    var lastPosition = null;

    var container = document.getElementById('map');
    var options = {
      center: new kakao.maps.LatLng(33.450701, 126.570667),
      level: 3
    };

    var map = new kakao.maps.Map(container, options);

    function moveToCurrentLocation(){
      if (navigator.geolocation) {
      
      // Geolocation API를 사용하여 접속 위치를 얻어옵니다.
      navigator.geolocation.getCurrentPosition(function(position) {
      
      var lat = position.coords.latitude,
      lon = position.coords.longitude;
      
      var locPosition = new kakao.maps.LatLng(lat, lon);
      
      // 마커와 인포윈도우를 표시합니다.
      displayMarker(locPosition);
      });
      } else { // Geolocation API가 지원되지 않으면
      
      alert("Geolocation is not supported by this browser.");
      
      }
    }

    function displayMarker(locPosition) {

      // 기존의 marker가 있으면 지워줍니다.
      if (marker != null) {
          marker.setMap(null);
      }
  
      // 마커 이미지의 이미지 크기 입니다
      let imageSize = new kakao.maps.Size(20, 20); 
  
      let markerImageSrc ='./src/star1.png';
      let markerImageOption ={offset :new kakao.maps.Point(17,34)};
      let markerImage=new kakao.maps.MarkerImage(markerImageSrc,imageSize ,markerImageOption);
  
      // 전역 변수인 marker에 새로운 Marker 객체를 할당합니다.
      marker = new kakao.maps.Marker({
          position: locPosition,
          image:markerImage
        }); 
  
        // 마커가 지도 위에 표시되도록 설정합니다
        marker.setMap(map);  
  
        // 지도 중심 좌표를 접속위치로 변경합니다.
        map.setCenter(locPosition);      
  }
  

    // 여러 포인트 지점 좌표 생성
    var pointPositions = [
    new kakao.maps.LatLng(37.55443, 126.89574),
    new kakao.maps.LatLng(37.54306, 126.91400),
    new kakao.maps.LatLng(37.52988, 126.95228),
    new kakao.maps.LatLng(37.51955, 126.99581),
    new kakao.maps.LatLng(37.53037, 127.06723),
    new kakao.maps.LatLng(37.54338, 127.10737),
    ];

    var imageSize = new kakao.maps.Size(40, 40);

    var markerImage = new kakao.maps.MarkerImage('./src/star1.png', imageSize);

    // 각 포인트 지점마다 마커 생성
    pointPositions.forEach(function (pointPosition) {
      var pointMarker = new kakao.maps.Marker({
          position: pointPosition,
          map: map,
          image: markerImage
      });
    });



    // 각도에 따른 방향 이미지 변환
    function rotateMarker(marker, angle) {
      let markerImageSrc;

      if (angle >= -22.5 && angle < 22.5) { markerImageSrc = './src/east.png'; } // 동
      else if (angle >= 22.5 && angle < 67.5) { markerImageSrc = './src/northeast.png'; } // 북동
      else if (angle >= 67.5 && angle < 112.5) { markerImageSrc = './src/north.png'; } // 북
      else if (angle >= 112.5 && angle < 157.5) { markerImageSrc = './src/northwest.png'; } // 북서
      else if ((angle >= 157.5 && angle <= 180) || (angle >= -180 && angle < -157)) { markerImageSrc = './src/west.png'; } // 서
      else if (angle > -157 && angle < -112) { markerImageSrc = './src/southwest.png' }//남서 
      else if (angle > -112 && angle < -67) { markerImageSrc = './src/east.png' }//남 
      else { markerImageSrc = './src/southeast.png' }//남동 

      var imageSize = new kakao.maps.Size(20, 20);
      var imageOption = { offset: new kakao.maps.Point(17, 34) };

      var changeMarkerImg = new kakao.maps.Marker({
        position: currentPosition,
        map: map,
        image: new kakao.maps.MarkerImage(markerImageSrc, imageSize, imageOption)
      });

      return changeMarkerImg;
    }

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(function (position) {
        var lat = position.coords.latitude,
          lon = position.coords.longitude;
    
        currentPosition = new kakao.maps.LatLng(lat, lon);
    
        // 지도의 중심을 현재 위치로 설정합니다.
        map.setCenter(currentPosition);
    
        if (marker != null) {
          marker.setMap(null);
        }
    
        if (lastPosition != null) {
          let angle = calculateAngle(lastPosition, currentPosition);
          marker = rotateMarker(marker, angle);
        } else {
          lastPosition = currentPosition;
        }
    
         // 모든 포인트 범위 안에 들어왔을때 사용자를 체크한다.
         pointPositions.forEach(function(pointPosition) {
           if (kakao.maps.geometry.distance(currentPosition, pointPosition) <= 1000) {
             alert("포인트 +1");
             window.close(); // 페이지 자동 종료
           }
         });
    
       }, function(error){
         console.log("Error occurred in watchPosition.");
         console.log(error);
       }, { 
         enableHighAccuracy: true,
         maximumAge: 30000,
         timeout: 27000
       });
    } else{
      console.log("Geolocation API가 지원하지 않습니다.");
    }
    

    // 두 지점 사이의 각도 계산
    function calculateAngle(startPoint, endPoint) {
      let dy = endPoint.getLat() - startPoint.getLat();
      let dx = endPoint.getLng() - startPoint.getLng();
      let theta = Math.atan2(dy, dx); // range (-PI, PI]

      theta *= 180 / Math.PI; // rads to degs, range (-180, 180]

      return theta;
    }


    // 폴리라인 생성
    var polyline = new kakao.maps.Polyline({
      strokeWeight: 3,
      strokeColor: "#db4040",
      strokeOpacity: 1,
      strokeStyle: 'solid'
    });

    function drawMultiPath() {
      // 여러 임의 좌표 생성
      var positions = [
        new kakao.maps.LatLng(37.65803, 126.84206),
        new kakao.maps.LatLng(37.65688, 126.84427),
        new kakao.maps.LatLng(37.65638, 126.84393),
        // 필요한 만큼 더 추가 가능
      ];

      // 현재 위치에서 임의 좌표까지 경로 설정
      polyline.setPath([currentPosition].concat(positions));

      // 지도에 선을 표시합니다 
      polyline.setMap(map);
    }

    

  </script>
</body>

</html>