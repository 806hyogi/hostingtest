<!DOCTYPE html>
<html style="height:100%;">
<head>
<meta charset="UTF-8">
<title>KaKaoMap Study</title>
</head>
<body style="margin:0; padding:0; height:100%;">
    <div id="map" style="width:100%;height:90%;"></div>

    <!-- 길찾기 링크 -->
    <input type="text" id="address" placeholder="주소를 입력하세요">
    <button onclick="searchAddress()">검색</button>
    
    <!-- 카카오 맵 API-->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=baa1f48d1a2ac62f865637b2ddb9ac08&libraries=services"></script>
    <script type="text/javascript">
        

        var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
        var options = { //지도를 생성할 때 필요한 기본 옵션
            center: new kakao.maps.LatLng(33.450701, 126.570667), //지도의 중심좌표.
            level: 3 //지도의 레벨(확대, 축소 정도)
        };

        var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴

        if (navigator.geolocation) { // Geolocation API 브라우저에서 지원되는지 확인
            // 현재 위치를 계속 추적하고 새로운 위치 정보가 사용가능할때마다 콜백 함수 호출
            navigator.geolocation.watchPosition(function(position) {
                var lat = position.coords.latitude, 
                    lon = position.coords.longitude;

                currentPosition = new kakao.maps.LatLng(lat, lon);
                
                var locPosition = new kakao.maps.LatLng(lat, lon); // 새로운 위도 경도 좌표

                map.setCenter(locPosition); 

                // 사용자의 위치가 업데이트 될때마다 기존 마커 제거
                if(marker != null){
                    marker.setMap(null);
                }

                var imageSize = new kakao.maps.Size(30, 30), 
                    imageOption = {offset: new kakao.maps.Point(20, 20)}; 

                // 마커 이미지 경로
                var markerImage = new kakao.maps.MarkerImage('./right.png', imageSize, imageOption),
                    markerPosition  = new kakao.maps.LatLng(lat, lon); 

                var marker = new kakao.maps.Marker({
                    position: markerPosition,
                    image : markerImage
                });

                // 마커를 지도에 추가
                marker.setMap(map);
            }, function(error){
                console.log("Error occurred in watchPosition.");
                console.log(error);
            }, {
                // 위치 정보 요청의 정확도 높이고 민감하게 반응
                enableHighAccuracy: true,
                maximumAge : 30000,
                timeout : 27000
            }
            
            );

        } else {
            console.log("Geolocation API가 지원하지 않습니다.");
        }

        // 주소-좌표 변환 객체를 생성합니다
        var geocoder = new kakao.maps.services.Geocoder();

        function searchAddress(){

            let address = document.getElementById('address').value;
            // 주소로 좌표를 검색합니다
            geocoder.addressSearch(address, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                    // 결과값으로 받은 위치를 마커로 표시합니다
                    var marker = new kakao.maps.Marker({
                        map: map,
                        position: coords
                    });

                    // 인포윈도우로 장소에 대한 설명을 표시합니다
                    var infowindow = new kakao.maps.InfoWindow({
                        content: '<div style="width:150px;text-align:center;padding:6px 0;">도착</div>'
                    });
                    
                    infowindow.open(map, marker);

                    // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                    map.setCenter(coords);

                    // 경로 그려주는 함수
                    drawPath(currentPosition, coords);
                } 
            });    
        }

        // 경로 그려주는 함수
        function drawPath(startPoint, endPoint){
            let polylinePath = [startPoint, endPoint];

            // 경로를 그립니다.
            let polyline = new kakao.maps.Polyline({
                path : polylinePath,
                strokeWeight : 3,
                strokeColor : "#db4040",
                strokeOpacity : 1,
                strokeStyle : 'solid'
            });
            polyline.setMap(map);
        }
    </script>
</body>
</html>

